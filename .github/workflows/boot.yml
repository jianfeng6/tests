name: Repack Boot Image via URL

on:
  workflow_dispatch:
    inputs:
      boot_img_url:
        description: 'URL of original boot.img'
        required: true
        default: 'https://example.com/path/to/boot.img'
      kernel_img_url:
        description: 'URL of new kernel Image'
        required: true
        default: 'https://example.com/path/to/Image'

jobs:
  repack_boot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4  # 更新到v4版本

      - name: Setup Workspace
        run: |
          mkdir -p ${{ github.workspace }}/downloads
          mkdir -p ${{ github.workspace }}/output

      - name: Download Magisk
        run: |
          wget -q https://github.com/topjohnwu/Magisk/releases/latest/download/magisk.apk
          ls -lh magisk.apk

      - name: Extract magiskboot
        run: |
          unzip -j magisk.apk 'lib/x86_64/libmagiskboot.so' -d .
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot
          ./magiskboot --version

      - name: Download Boot Image
        run: |
          wget -O ${{ github.workspace }}/downloads/boot.img "${{ github.event.inputs.boot_img_url }}"
          file ${{ github.workspace }}/downloads/boot.img

      - name: Download Kernel Image
        run: |
          wget -O ${{ github.workspace }}/downloads/Image "${{ github.event.inputs.kernel_img_url }}"
          file ${{ github.workspace }}/downloads/Image

      - name: Unpack Boot Image
        run: |
          ./magiskboot unpack ${{ github.workspace }}/downloads/boot.img
          ls -l split_img/

      - name: Replace Kernel
        run: |
          cp -v ${{ github.workspace }}/downloads/Image split_img/kernel
          md5sum split_img/kernel

      - name: Repack Boot Image
        run: |
          ./magiskboot repack ${{ github.workspace }}/downloads/boot.img
          mv -v new-boot.img ${{ github.workspace }}/output/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4  # 必须更新到v4版本
        with:
          name: custom_boot_image
          path: ${{ github.workspace }}/output/new-boot.img